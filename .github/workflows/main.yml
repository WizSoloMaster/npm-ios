name: Build unsigned IPA (no signing)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Xcode version
        run: xcodebuild -version

      - name: List schemes (debug)
        run: xcodebuild -list -project NPM.xcodeproj

      - name: Patch SecureField compile error (Xcode 16)
        shell: bash
        run: |
          set -euo pipefail
          FILE="NPM/Views/AccessListFormView.swift"

          if [ ! -f "$FILE" ]; then
            echo "Patch file not found: $FILE"
            find . -maxdepth 5 -type f -name "AccessListFormView.swift" -print
            exit 1
          fi

          perl -pi -e 's/SecureField\(LocalizedStringResource\(stringLiteral:\s*credential\.hint\),\s*text:\s*\$credential\.password\)/SecureField(credential.hint, text: \$credential.password)/g' "$FILE"

          if grep -q "LocalizedStringResource(stringLiteral: credential.hint)" "$FILE"; then
            echo "Patch did not apply (pattern still present)."
            exit 1
          fi

      - name: Build archive (NO codesign)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p build

          xcodebuild clean archive \
            -project NPM.xcodeproj \
            -scheme "NPM" \
            -configuration Release \
            -archivePath "$PWD/build/unsigned.xcarchive" \
            -destination "generic/platform=iOS" \
            SKIP_INSTALL=NO \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            | tee build/xcodebuild.log

      - name: Package unsigned IPA
        shell: bash
        run: |
          set -euo pipefail

          APP_DIR="$PWD/build/unsigned.xcarchive/Products/Applications"
          echo "Looking for .app in: $APP_DIR"
          ls -la "$APP_DIR"

          # Find the first *.app directory safely (no fragile quoting)
          APP_PATH="$(/usr/bin/find "$APP_DIR" -maxdepth 1 -type d -name '*.app' | /usr/bin/head -n 1)"

          if [ -z "${APP_PATH:-}" ]; then
            echo "ERROR: No .app found to package."
            exit 1
          fi

          echo "Found app: $APP_PATH"

          rm -rf build/Payload
          mkdir -p build/Payload
          cp -R "$APP_PATH" build/Payload/

          # IPA is a zip containing Payload/<App>.app
          (cd build && /usr/bin/zip -r npm-ios-unsigned.ipa Payload)

          echo "Created:"
          ls -la build/npm-ios-unsigned.ipa

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: npm-ios-unsigned-ipa
          path: build/npm-ios-unsigned.ipa

      - name: Upload build log
        uses: actions/upload-artifact@v4
        with:
          name: xcodebuild-log
          path: build/xcodebuild.log

