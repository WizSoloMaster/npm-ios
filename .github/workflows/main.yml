name: Build unsigned IPA (no signing)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Xcode version
        run: xcodebuild -version

      - name: List schemes (debug)
        run: xcodebuild -list -project NPM.xcodeproj

      # Fix for Xcode 16.x SwiftUI SecureField initializer mismatch:
      # SecureField(LocalizedStringResource(...), text: ...) -> SecureField(String, text: ...)
      - name: Patch SecureField compile error
        shell: bash
        run: |
          set -euo pipefail
          FILE="NPM/Views/AccessListFormView.swift"

          if [ ! -f "$FILE" ]; then
            echo "Patch file not found: $FILE"
            find . -maxdepth 3 -type f -name "AccessListFormView.swift" -print
            exit 1
          fi

          echo "Before patch (matching lines):"
          grep -n "SecureField(" "$FILE" || true

          perl -pi -e 's/SecureField\(LocalizedStringResource\(stringLiteral:\s*credential\.hint\),\s*text:\s*\$credential\.password\)/SecureField(credential.hint, text: \$credential.password)/g' "$FILE"

          echo "After patch (matching lines):"
          grep -n "SecureField(" "$FILE" || true

          # Optional: fail fast if the original pattern still exists
          if grep -q "LocalizedStringResource(stringLiteral: credential.hint)" "$FILE"; then
            echo "Patch did not apply (pattern still present)."
            exit 1
          fi

      - name: Build archive (NO codesign)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p build

          xcodebuild clean archive \
            -project NPM.xcodeproj \
            -scheme "NPM" \
            -configuration Release \
            -archivePath "$PWD/build/unsigned.xcarchive" \
            -destination "generic/platform=iOS" \
            SKIP_INSTALL=NO \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            | tee build/xcodebuild.log

      - name: Package unsigned .ipa
        shell: bash
        run: |
          set -euo pipefail

          APP_DIR="$PWD/build/unsigned.xcarchive/Products/Applications"
          echo "Looking for .app in: $APP_DIR"
          ls -la "$APP_DIR" || true

          APP_PATH="$(find "$APP_DIR" -maxdepth 1 -name "*.
